{% extends "hyp/layout.html" %}
{% load static %}
{% block head_tags %}
  <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
  <script src={% static "js/charts.js" %}></script>
{% endblock %}

{% block content %}
  <div id="experiment-dashboard">
    <h2 class="header">{{ experiment.description }}</h2>

    <div class="row">
      <div id="total-interactions">
        <p>Unique participants</p>
        <h2>
          {% if experiment.total_interactions > 0 %}
          {{ experiment.total_interactions }}
          {% else %}
          No one has participated in this experiment yet.
          {% endif %}
        </h2>
      </div>

      <div id="uncertainty">
        <p>Uncertainty</p>
        <h2>{{ experiment.uncertainty_level  }}</h2>
      </div>
    </div>

    <div id="chart-container">
      <span id="toggles">
        <button id="show-traffic-splits" class="button-primary">Traffic splits</button>
        <button id="show-conversion-rates">Conversion rates</button>
      </span>
      <div id="experiment-chart"></div>
    </div>

    <div id="variants">
      {% for variant in experiment.variant_set.all %}
      <div class="variant-details">
        <h3>{{ variant.name }}</h3>
        {% if variant.num_interactions == 0 %}
        <p>No one has interacted with this variant yet.</p>
        {% else %}
        <p>Traffic to date: {% widthratio variant.traffic_split_to_date 0.01 1 %}%</p>
        <p>Conversion rate: {% widthratio variant.conversion_rate 1 100 %}%</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>

  {{ experiment.history|json_script:"experiment-metrics" }}

  <script>
    let metricName = "traffic_split";
    let chart;

    document.querySelector("#show-traffic-splits").onclick = function(event) {
      document.querySelector("#chart-container #toggles .button-primary").classList.remove("button-primary")
      event.currentTarget.classList.add("button-primary")
      metricName = "traffic_split";
      renderChart();
    };

    document.querySelector("#show-conversion-rates").onclick = function(event) {
      document.querySelector("#chart-container #toggles .button-primary").classList.remove("button-primary")
      event.currentTarget.classList.add("button-primary")
      metricName = "conversion_rate";
      renderChart();
    };

    function renderChart() {
      if (chart) {
        chart.dispose();
      }

      const metricsByVariant = JSON.parse(document.getElementById("experiment-metrics").textContent);
      let title = metricName.replace("_", " ") + " by variant";
      title = title[0].toUpperCase() + title.slice(1);

      chart = renderDateLineChart({
        title: title,
        containerId: "experiment-chart",
        data: metricsByVariant,
        dataKey: metricName,
      });
    }

    am4core.ready(renderChart);
  </script>
{% endblock %}
